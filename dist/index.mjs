import X from'fs';import h from'path';import f from'fs-extra';import {execSync}from'child_process';import rt from'crypto';import {jsx}from'react/jsx-runtime';var K=Object.defineProperty;var P=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var q=(t,e)=>()=>(t&&(e=t(t=0)),e);var V=(t,e)=>{for(var i in e)K(t,i,{get:e[i],enumerable:true});};function tt(){try{let t=process.cwd(),e=h.join(t,"squoosh-image.config.js");if(X.existsSync(e))return P(e)}catch(t){console.warn("Failed to load squoosh-image.config.js, using default config:",t);}return {}}function g(){let t=tt();return {...Z,...t}}var Z,d=q(()=>{Z={quality:75,format:"webp",imageDirs:["public","src"],outputPath:".squoosh-cache",responsive:true,breakpoints:[640,750,828,1080,1200,1920],useCache:true,cacheDir:".squoosh-cache"};});function C(t){if(t.startsWith("/")||t.startsWith("http")||t.startsWith("data:"))return t;let e=g(),i=process.cwd();for(let r of e.imageDirs){let o=h.join(i,r,t);if(f.existsSync(o))return o}return h.join(i,"public",t)}function y(t,e){let i=g(),{width:r,height:o,quality:n=i.quality,format:s=i.format}=e,c=t.replace(/^\//,"").replace(/[\/\\?%*:|"<>]/g,"-"),a=r||o?`-${r||"auto"}x${o||"auto"}`:"",m=`-q${n}`,p=`${h.basename(c,h.extname(c))}${a}${m}.${s}`;return h.join(i.outputPath,p)}function k(t,e){if(!t||!e)return [];let i=g(),r=t/e;return i.breakpoints.filter(o=>o<=t*2).map(o=>({width:o,height:Math.round(o/r)}))}async function D(){let t=g();await f.ensureDir(t.outputPath),t.useCache&&await f.ensureDir(t.cacheDir);}var R=q(()=>{d();});function F(t,e){let i=f.readFileSync(t);return rt.createHash("md5").update(i).update(JSON.stringify(e)).digest("hex")}function ot(t,e){let i=g();if(!i.useCache)return null;let r=F(t,e),o=_(e.format),n=h.join(i.cacheDir,`${h.basename(t,h.extname(t))}.${r}.${o}`);return f.existsSync(n)?n:null}function _(t){return {mozjpeg:"jpg",webp:"webp",avif:"avif",png:"png",jxl:"jxl",wp2:"wp2",original:""}[t]||h.extname(t).substring(1)||t}function nt(t){let e=[],{format:i,quality:r,resize:o,width:n,height:s,preserveAspectRatio:c}=t;switch(i){case "mozjpeg":e.push("--mozjpeg",`{"quality":${r}}`);break;case "webp":e.push("--webp",`{"quality":${r}}`);break;case "avif":e.push("--avif",`{"quality":${r}}`);break;case "png":e.push("--oxipng",'{"level":3}');break;case "jxl":e.push("--jxl",`{"quality":${r}}`);break;case "wp2":e.push("--wp2",`{"quality":${r}}`);break;}if(o&&(n||s)){let a={};n&&(a.width=n),s&&(a.height=s),c!==void 0&&(a.fitMethod=c?"contain":"stretch"),e.push("--resize",JSON.stringify(a));}return e}async function b(t,e,i){await f.ensureDir(h.dirname(e));let r=ot(t,i);if(r)return await f.copy(r,e),e;if(i.format==="original")return await f.copy(t,e),e;let o=nt(i);try{let n=["npx","@squoosh/cli",...o,"--output-dir",h.dirname(e),"--output-filename",h.basename(e,h.extname(e)),t].join(" ");execSync(n,{stdio:"inherit"});let s=g();if(s.useCache){let c=F(t,i),a=_(i.format),m=h.join(s.cacheDir,`${h.basename(t,h.extname(t))}.${c}.${a}`);await f.ensureDir(s.cacheDir),await f.copy(e,m);}return e}catch(n){throw console.error("Error optimizing image:",n),n}}var H=q(()=>{d();});var J={};V(J,{createBlurDataURL:()=>ct,getImageMetadata:()=>st,optimize:()=>at});async function at(t,e={}){let i=C(t),r=g(),o=e.quality??r.quality,n=e.format??r.format;if(await D(),(e.generateResponsive??r.responsive)&&e.width&&e.height){let a=k(e.width,e.height).map(async u=>{let l=y(t,{width:u.width,height:u.height,quality:o,format:n});return await b(i,l,{format:n,quality:o,resize:true,width:u.width,height:u.height,preserveAspectRatio:true}),{width:u.width,path:l}}),m=await Promise.all(a),p=y(t,{width:e.width,height:e.height,quality:o,format:n});await b(i,p,{format:n,quality:o,resize:true,width:e.width,height:e.height,preserveAspectRatio:true});let x=m.map(u=>`${h.relative(process.cwd(),u.path)} ${u.width}w`).join(", ");return {src:h.relative(process.cwd(),p),srcSet:x,sizes:"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"}}let s=y(t,{width:e.width,height:e.height,quality:o,format:n});return await b(i,s,{format:n,quality:o,resize:!!(e.width||e.height),width:e.width,height:e.height,preserveAspectRatio:true}),h.relative(process.cwd(),s)}async function st(t){return {width:1200,height:800,format:h.extname(t).substring(1)}}async function ct(t){let e=C(t),i=y(t,{width:10,height:10,quality:20,format:"webp"});return await b(e,i,{format:"webp",quality:20,resize:true,width:10,height:10,preserveAspectRatio:true}),"data:image/webp;base64,UklGRkAAAABXRUJQVlA4IDQAAADQAQCdASoQAAQABUB8JaQAA3AA/vA6WAAAAA=="}var M=q(()=>{d();R();H();});d();var et=({src:t,alt:e,width:i,height:r,quality:o,format:n,loading:s="lazy",objectFit:c,objectPosition:a,fill:m=false,sizes:p,priority:x=false,placeholder:$="empty",blurDataURL:u,onLoadingComplete:l,layout:ut,...B})=>{let z=g(),E=v=>{l&&l(v);},N=x?"eager":s,U=typeof t=="string"?`/__squoosh-image__/${encodeURIComponent(t)}?q=${o||z.quality}&fmt=${n||z.format}`:t,W=m?{width:"100%",height:"100%"}:{width:i,height:r},T=m?{position:"absolute",top:0,left:0,bottom:0,right:0,boxSizing:"border-box",padding:0,border:"none",margin:"auto",display:"block",width:"0",height:"0",minWidth:"100%",maxWidth:"100%",minHeight:"100%",maxHeight:"100%",objectFit:c||"cover",objectPosition:a||"center"}:{objectFit:c,objectPosition:a},L=$==="blur"&&u?{backgroundSize:c||"cover",backgroundPosition:a||"center",backgroundRepeat:"no-repeat",backgroundImage:`url("${u}")`}:{},G=m?{position:"relative",width:"100%",height:"100%"}:{},A=jsx("img",{src:U,alt:e,...W,loading:N,decoding:"async",style:{...T,...L},sizes:p,onLoad:v=>E(v.currentTarget),...B});return m?jsx("div",{style:G,children:A}):A},O={Image:et};function mt(t){let{nextConfig:e,squooshOptions:i}=t;return {...e,webpack:(r,o)=>(r.module.rules.push({test:/\.(png|jpe?g|gif|svg|webp|avif)$/i,issuer:{not:/\.(css|scss|sass)$/},use:[{loader:h.resolve(__dirname,"../../webpack/loader.js"),options:i||{}}]}),typeof e.webpack=="function"?e.webpack(r,o):r),babel:{...e.babel||{},plugins:[...e.babel?.plugins||[],h.resolve(__dirname,"../../babel/plugin.js")]}}}async function gt(t,e){let{optimize:i}=await Promise.resolve().then(()=>(M(),J));try{let r=t.query.src,o=t.query.w?parseInt(t.query.w,10):void 0,n=t.query.h?parseInt(t.query.h,10):void 0,s=t.query.q?parseInt(t.query.q,10):void 0,c=t.query.fmt;if(!r){e.status(400).json({error:"Missing src parameter"});return}let a=await i(r,{width:o,height:n,quality:s,format:c,generateResponsive:!1}),m=typeof a=="string"?a:a.src;e.setHeader("Content-Type",`image/${c||"webp"}`),e.setHeader("Cache-Control","public, max-age=31536000, immutable"),(await import('fs-extra')).createReadStream(m).pipe(e);}catch(r){console.error("Error optimizing image:",r),e.status(500).json({error:"Failed to optimize image"});}}
export{O as Image,gt as imageOptimizationHandler,mt as withSquooshImage};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map